# Стандарт использования транзакций

**Версия:** 1.0  
**Приоритет:** Критичный  
**Источник:** Глава 9. Работа с данными

---

## Правило: ВСЕГДА использовать транзакции при записи

**Критично:** Операции записи данных (`Записать`, `Удалить`, `Провести`) ДОЛЖНЫ выполняться внутри транзакции.

```bsl
// ❌ НЕПРАВИЛЬНО: Нет транзакции
НовыйОбъект = Справочники.Товары.СоздатьЭлемент();
НовыйОбъект.Наименование = "Новый товар";
НовыйОбъект.Записать(); // ОШИБКА: нет транзакции

// ✅ ПРАВИЛЬНО: Использование транзакции
НачатьТранзакцию();
Попытка
    НовыйОбъект = Справочники.Товары.СоздатьЭлемент();
    НовыйОбъект.Наименование = "Новый товар";
    НовыйОбъект.Записать();
    ЗафиксироватьТранзакцию();
Исключение
    ОтменитьТранзакцию();
    ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
    ЗаписьЖурналаРегистрации("Ошибка", УровеньЖурналаРегистрации.Ошибка,,, ТекстОшибки);
    ВызватьИсключение;
КонецПопытки;
```

---

## Структура транзакции

1. `НачатьТранзакцию()` — начало транзакции
2. `Попытка...Исключение` — обработка ошибок
3. `ЗафиксироватьТранзакцию()` — фиксация при успехе
4. `ОтменитьТранзакцию()` — откат при ошибке

---

---

## Использование транзакций при чтении данных

**Правило:** Ответственное чтение данных (на основе результатов которого производятся изменения или принимаются решения) следует производить в транзакции с предварительной установкой управляемых блокировок.

```bsl
// ❌ НЕПРАВИЛЬНО: Чтение без транзакции перед записью
Запрос = Новый Запрос("ВЫБРАТЬ ЗаметкиПоПредмету.КоличествоЗаметок ИЗ РегистрСведений.ЗаметкиПоПредмету КАК ЗаметкиПоПредмету ГДЕ ЗаметкиПоПредмету.Предмет = &Предмет");
Запрос.УстановитьПараметр("Предмет", ПредметЗаметок);
Выборка = Запрос.Выполнить().Выбрать();
КоличествоЗаметок = 0;
Если Выборка.Следующий() Тогда
    КоличествоЗаметок = Выборка.КоличествоЗаметок;
КонецЕсли;

НаборЗаписей = РегистрыСведений.ЗаметкиПоПредмету.СоздатьНаборЗаписей();
НоваяЗапись = НаборЗаписей.Добавить();
НоваяЗапись.КоличествоЗаметок = КоличествоЗаметок + 1;
НаборЗаписей.Записать();

// ✅ ПРАВИЛЬНО: Ответственное чтение в транзакции с блокировкой
НачатьТранзакцию();
Попытка
    // Установить исключительную блокировку
    БлокировкаДанных = Новый БлокировкаДанных;
    ЭлементБлокировкиДанных = БлокировкаДанных.Добавить("РегистрСведений.ЗаметкиПоПредмету");
    ЭлементБлокировкиДанных.УстановитьЗначение("Предмет", ПредметЗаметок);
    ЭлементБлокировкиДанных.Режим = РежимБлокировкиДанных.Исключительный;
    БлокировкаДанных.Заблокировать();
    
    // Прочитать регистр сведений
    Запрос = Новый Запрос("ВЫБРАТЬ ЗаметкиПоПредмету.КоличествоЗаметок ИЗ РегистрСведений.ЗаметкиПоПредмету КАК ЗаметкиПоПредмету ГДЕ ЗаметкиПоПредмету.Предмет = &Предмет");
    Запрос.УстановитьПараметр("Предмет", ПредметЗаметок);
    Выборка = Запрос.Выполнить().Выбрать();
    КоличествоЗаметок = 0;
    Если Выборка.Следующий() Тогда
        КоличествоЗаметок = Выборка.КоличествоЗаметок;
    КонецЕсли;
    
    // Записать в регистр сведений
    НаборЗаписей = РегистрыСведений.ЗаметкиПоПредмету.СоздатьНаборЗаписей();
    НоваяЗапись = НаборЗаписей.Добавить();
    НоваяЗапись.КоличествоЗаметок = КоличествоЗаметок + 1;
    НаборЗаписей.Записать();
    
    ЗафиксироватьТранзакцию();
Исключение
    ОтменитьТранзакцию();
    ЗаписьЖурналаРегистрации("Заметки", УровеньЖурналаРегистрации.Ошибка,,, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
    ВызватьИсключение;
КонецПопытки;
```

**Когда требуется ответственное чтение:**
- Чтение данных при проведении для последующего формирования движений
- Чтение данных для последующей целостной передачи в другую систему
- Выполнение групповой обработки объектов

**Когда ответственное чтение НЕ требуется:**
- Получение данных динамическими списками
- Поиск данных
- Формирование большинства отчетов
- Обращение к условно постоянной информации (константы, учетная политика)

**Источник:** Раздел 11. Использование транзакций при чтении данных (строки 3452-3506)

---

## Избегание длинных транзакций

**Правило:** Следует избегать длительных транзакций, которые выполняются длительное время.

```bsl
// ❌ НЕПРАВИЛЬНО: Длинная транзакция с долгими вычислениями
НачатьТранзакцию();
Попытка
    Для Каждого Элемент Из БольшаяКоллекция Цикл
        НовыйОбъект = Справочники.Товары.СоздатьЭлемент();
        НовыйОбъект.Наименование = Элемент.Наименование;
        НовыйОбъект.Записать();
    КонецЦикла;
    
    // Долгие вычисления внутри транзакции
    Результат = ВыполнитьДолгиеВычисления();
    
    ЗафиксироватьТранзакцию();
Исключение
    ОтменитьТранзакцию();
КонецПопытки;

// ✅ ПРАВИЛЬНО: Вычисления вне транзакции
Результат = ВыполнитьДолгиеВычисления();

НачатьТранзакцию();
Попытка
    Для Каждого Элемент Из БольшаяКоллекция Цикл
        НовыйОбъект = Справочники.Товары.СоздатьЭлемент();
        НовыйОбъект.Наименование = Элемент.Наименование;
        НовыйОбъект.Записать();
    КонецЦикла;
    
    ЗафиксироватьТранзакцию();
Исключение
    ОтменитьТранзакцию();
КонецПопытки;
```

**Почему важно:** Длинные транзакции отнимают ресурсы сервера и СУБД, блокировки остаются до конца транзакции, что снижает параллельность системы.

**Источник:** Раздел 11. Избегание длинных транзакций (строки 3529-3541)

---

## Блокировка данных объекта для редактирования

**Правило:** Прежде чем изменять существующий объект из кода, следует предварительно его заблокировать.

```bsl
// ❌ НЕПРАВИЛЬНО: Изменение без блокировки
Объект = Ссылка.ПолучитьОбъект();
Объект.Реквизит = НовоеЗначение;
Объект.Записать();

// ✅ ПРАВИЛЬНО: Блокировка перед изменением
Объект = Ссылка.ПолучитьОбъект();
Попытка
    Объект.Заблокировать();
    Объект.Реквизит = НовоеЗначение;
    Объект.Записать();
Исключение
    ТекстОшибки = "Не удалось заблокировать запись. Объект уже заблокирован: " + ОписаниеОшибки();
    Сообщить(ТекстОшибки);
    ВызватьИсключение;
КонецПопытки;
```

**Когда НЕ требуется проверка блокировки:**
- При выполнении операций с большим приоритетом (загрузка данных при обмене)
- При действиях в монопольном режиме (обновление ИБ, первоначальное заполнение)

**Источник:** Раздел 11. Блокировка данных объекта для редактирования (строки 3430-3451)

---

## Чтение отдельных реквизитов объекта

**Правило:** Для чтения значений отдельных реквизитов следует использовать запрос, а не метод `ПолучитьОбъект()`.

```bsl
// ❌ НЕПРАВИЛЬНО: Загрузка всего объекта для чтения реквизитов
СтранаСсылка = ...;
КодСтраны = СтранаСсылка.Код; // Загружает объект целиком
НаименованиеСтраны = СтранаСсылка.Наименование;

// ✅ ПРАВИЛЬНО: Использование запроса для чтения реквизитов
Запрос = Новый Запрос("ВЫБРАТЬ СтраныМира.Код, СтраныМира.Наименование ИЗ Справочник.СтраныМира КАК СтраныМира ГДЕ СтраныМира.Ссылка = &Ссылка");
Запрос.УстановитьПараметр("Ссылка", Ссылка);
Выборка = Запрос.Выполнить().Выбрать();
Выборка.Следующий();
КодСтраны = Выборка.Код;
НаименованиеСтраны = Выборка.Наименование;
```

**Источник:** Раздел 11. Чтение отдельных реквизитов объекта (строки 3549-3563)

---

## Чек-лист проверки

- [ ] Все операции записи выполняются внутри транзакции
- [ ] Используется `Попытка...Исключение` для обработки ошибок
- [ ] При успехе вызывается `ЗафиксироватьТранзакцию()`
- [ ] При ошибке вызывается `ОтменитьТранзакцию()`
- [ ] Ответственное чтение выполняется в транзакции с блокировкой
- [ ] Избегаются длинные транзакции (вычисления вне транзакции)
- [ ] Объекты блокируются перед изменением
- [ ] Для чтения отдельных реквизитов используются запросы

---

**Ссылки на исходный документ:**
- Раздел 11: Транзакции и блокировки (строки 3387-3670)
- Раздел 11. Использование транзакций при чтении данных (строки 3452-3506)
- Раздел 11. Избегание длинных транзакций (строки 3529-3541)
- Раздел 11. Блокировка данных объекта для редактирования (строки 3430-3451)
- Раздел 11. Чтение отдельных реквизитов объекта (строки 3549-3563)

