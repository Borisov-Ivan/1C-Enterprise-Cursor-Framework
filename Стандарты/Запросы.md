# Стандарт работы с запросами

**Версия:** 1.0  
**Приоритет:** Критичный  
**Источник:** Раздел 10. Работа с запросами (строки 2417-3386)

---

## Описание

Стандарт определяет правила написания, оптимизации и использования запросов в конфигурации 1С:Предприятие. Включает требования к оформлению текстов запросов, оптимизацию производительности, работу с виртуальными таблицами и предотвращение проблем N+1.

---

## Правила оформления текстов запросов

### 1. Ключевые слова заглавными буквами

**Правило:** Все ключевые слова языка запросов пишутся заглавными буквами.

```bsl
// ❌ НЕПРАВИЛЬНО
Запрос.Текст = "выбрать * из справочник.Товары";

// ✅ ПРАВИЛЬНО
Запрос.Текст = "ВЫБРАТЬ * ИЗ Справочник.Товары";
```

**Источник:** Раздел 10.1 (строка 2420)

---

### 2. Явное назначение псевдонимов полей

**Правило:** Рекомендуется указывать псевдонимы полей явно для повышения наглядности и устойчивости кода.

```bsl
// ❌ НЕПРАВИЛЬНО: Автоматический псевдоним
Запрос.Текст = "ВЫБРАТЬ Касса.Валюта ИЗ Справочник.Кассы КАК Касса";
// Поле получит псевдоним ВалютаНаименование (не Наименование)

// ✅ ПРАВИЛЬНО: Явный псевдоним
Запрос.Текст = "ВЫБРАТЬ Касса.Валюта КАК Валюта ИЗ Справочник.Кассы КАК Касса";
```

**Источник:** Раздел 10.1 (строки 2424-2438)

---

### 3. Структурирование текста запроса

**Правило:** Текст запроса должен быть структурирован, не следует писать запрос в одну строку.

```bsl
// ❌ НЕПРАВИЛЬНО: Запрос в одну строку
Запрос.Текст = "ВЫБРАТЬ Номенклатура.Ссылка КАК Товар ИЗ Справочник.Номенклатура КАК Номенклатура ГДЕ Номенклатура.ПометкаУдаления = ЛОЖЬ";

// ✅ ПРАВИЛЬНО: Структурированный запрос
Запрос.Текст = 
"ВЫБРАТЬ
|    Номенклатура.Ссылка КАК Товар
|ИЗ
|    Справочник.Номенклатура КАК Номенклатура
|ГДЕ
|    Номенклатура.ПометкаУдаления = ЛОЖЬ";
```

**Источник:** Раздел 10.1 (строка 2439)

---

### 4. Комментарии в сложных запросах

**Правило:** В запросы, сложные для понимания (с вложенными запросами, объединениями, соединениями), рекомендуется вставлять комментарии.

```bsl
// ✅ ПРАВИЛЬНО: Комментарии в запросе
Запрос.Текст = 
"ВЫБРАТЬ
|    Номенклатура.Ссылка КАК Товар,
|    ЕСТЬNULL(Остатки.КоличествоОстаток, 0) КАК Остаток
|ИЗ
|    Справочник.Номенклатура КАК Номенклатура
|    // Соединение с остатками для получения количества товара на складе
|    ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки() КАК Остатки
|        ПО Номенклатура.Ссылка = Остатки.Номенклатура";
```

**⚠️ ВАЖНО:** При использовании конструктора запросов все комментарии удаляются автоматически без предупреждения.

**Источник:** Раздел 10.1 (строки 2440-2442)

---

## Многократное выполнение однотипных запросов (N+1)

**Правило:** Рекомендуется получать все необходимые однотипные данные одним запросом вместо выполнения серии запросов.

```bsl
// ❌ НЕПРАВИЛЬНО: Множественные запросы в цикле (N+1)
БанкиДляОбработки = Новый Массив;
// ... заполнение массива ...

Для Каждого Банк Из БанкиДляОбработки Цикл
    ЧастныйЗапрос = Новый Запрос("ВЫБРАТЬ БанковскиеСчета.Ссылка КАК Счет ИЗ Справочник.БанковскиеСчета КАК БанковскиеСчета ГДЕ БанковскиеСчета.Банк = &Банк");
    ЧастныйЗапрос.УстановитьПараметр("Банк", Банк);
    ВыборкаСчетов = ЧастныйЗапрос.Выполнить().Выбрать();
    Пока ВыборкаСчетов.Следующий() Цикл
        ОбработатьСчетаВБанке(ВыборкаСчетов.Счет);
    КонецЦикла;
КонецЦикла;

// ✅ ПРАВИЛЬНО: Один запрос для всех банков
БанкиДляОбработки = Новый Массив;
// ... заполнение массива ...

ОбщийЗапрос = Новый Запрос("ВЫБРАТЬ БанковскиеСчета.Ссылка КАК Счет ИЗ Справочник.БанковскиеСчета КАК БанковскиеСчета ГДЕ БанковскиеСчета.Банк В(&БанкиДляОбработки)");
ОбщийЗапрос.УстановитьПараметр("БанкиДляОбработки", БанкиДляОбработки);
ВыборкаСчетов = ОбщийЗапрос.Выполнить().Выбрать();
Пока ВыборкаСчетов.Следующий() Цикл
    ОбработатьСчетаВБанке(ВыборкаСчетов.Счет);
КонецЦикла;
```

**Источник:** Раздел 10.2 (строки 2488-2496)

---

## Проверка на пустой результат выполнения запроса

**Правило:** Проверку того, что результат выполнения запроса не содержит строк, следует выполнять с помощью метода `Пустой()`.

```bsl
// ❌ НЕПРАВИЛЬНО: Избыточная выборка для проверки
Выборка = Запрос.Выполнить().Выбрать();
Если Выборка.Следующий() Тогда
    Возврат Истина;
Иначе
    Возврат Ложь;
КонецЕсли;

// ✅ ПРАВИЛЬНО: Использование метода Пустой()
Возврат НЕ Запрос.Выполнить().Пустой();
```

**⚠️ ВАЖНО:** Если требуется выбрать результат запроса, предварительный вызов метода `Пустой()` не требуется.

**Источник:** Раздел 10.3 (строки 2498-2528)

---

## Ограничение на использование ПОЛНОЕ ВНЕШНЕЕ СОЕДИНЕНИЕ

**Правило:** В общем случае не рекомендуется использовать конструкцию `ПОЛНОЕ ВНЕШНЕЕ СОЕДИНЕНИЕ` в запросах, особенно при работе с PostgreSQL.

```bsl
// ❌ НЕПРАВИЛЬНО: ПОЛНОЕ ВНЕШНЕЕ СОЕДИНЕНИЕ
Запрос.Текст = 
"ВЫБРАТЬ
|    ЕСТЬNULL(ПланПродаж.Номенклатура, ФактическиеПродажи.Номенклатура) КАК Номенклатура,
|    ЕСТЬNULL(ПланПродаж.Сумма, 0) КАК СуммаПлан,
|    ЕСТЬNULL(ФактическиеПродажи.Сумма, 0) КАК СуммаФакт
|ИЗ
|    ПланПродаж КАК ПланПродаж
|    ПОЛНОЕ СОЕДИНЕНИЕ ФактическиеПродажи КАК ФактическиеПродажи
|        ПО ПланПродаж.Номенклатура = ФактическиеПродажи.Номенклатура";

// ✅ ПРАВИЛЬНО: ОБЪЕДИНИТЬ вместо ПОЛНОЕ СОЕДИНЕНИЕ
Запрос.Текст = 
"ВЫБРАТЬ
|    ПланФактПродаж.Номенклатура КАК Номенклатура,
|    СУММА(ПланФактПродаж.СуммаПлан) КАК СуммаПлан,
|    СУММА(ПланФактПродаж.СуммаФакт) КАК СуммаФакт
|ИЗ
|    (ВЫБРАТЬ
|        ПланПродаж.Номенклатура КАК Номенклатура,
|        ПланПродаж.Сумма КАК СуммаПлан,
|        0 КАК СуммаФакт
|    ИЗ ПланПродаж
|    ОБЪЕДИНИТЬ ВСЕ
|    ВЫБРАТЬ
|        ФактическиеПродажи.Номенклатура,
|        0,
|        ФактическиеПродажи.Сумма
|    ИЗ ФактическиеПродажи КАК ФактическиеПродажи) КАК ПланФактПродаж
|СГРУППИРОВАТЬ ПО
|    ПланФактПродаж.Номенклатура";
```

**Источник:** Раздел 10.4 (строки 2530-2574)

---

## Упорядочивание результатов запроса

**Правило:** Если алгоритм обработки результатов запроса зависит от порядка записей или результат представляется пользователю, следует использовать предложение `УПОРЯДОЧИТЬ ПО`.

```bsl
// ❌ НЕПРАВИЛЬНО: Отсутствие упорядочивания
Запрос.Текст = 
"ВЫБРАТЬ
|    Номенклатура.Наименование КАК Наименование
|ИЗ
|    Справочник.Номенклатура КАК Номенклатура";

// ✅ ПРАВИЛЬНО: Упорядочивание по строковому представлению
Запрос.Текст = 
"ВЫБРАТЬ
|    Номенклатура.Наименование КАК Наименование
|ИЗ
|    Справочник.Номенклатура КАК Номенклатура
|УПОРЯДОЧИТЬ ПО
|    Номенклатура.Наименование";
```

**⚠️ ВАЖНО:** 
- Упорядочивание по полям ссылочных типов нужно заменять на упорядочивание по строковым представлениям этих полей.
- Отсутствие `УПОРЯДОЧИТЬ ПО` оправдано только если порядок не важен и результат не показывается пользователю.

**Источник:** Раздел 10.5 (строки 2591-2615)

---

## Псевдонимы источников данных

**Правило:** Псевдоним источника данных должен быть осмысленным и описывать назначение источника в запросе.

```bsl
// ❌ НЕПРАВИЛЬНО: Неосмысленные псевдонимы
Запрос.Текст = 
"ВЫБРАТЬ
|    Таблица1.Ссылка КАК Товар,
|    ЕСТЬNULL(Таблица2.КоличествоОстаток, 0) КАК Остаток
|ИЗ
|    Справочник.Номенклатура КАК Таблица1
|    ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки КАК Таблица2
|        ПО Таблица1.Ссылка = Таблица2.Номенклатура";

// ✅ ПРАВИЛЬНО: Осмысленные псевдонимы
Запрос.Текст = 
"ВЫБРАТЬ
|    ВсяНоменклатура.Ссылка КАК Товар,
|    ЕСТЬNULL(ОстаткиНаСкладах.КоличествоОстаток, 0) КАК Остаток
|ИЗ
|    Справочник.Номенклатура КАК ВсяНоменклатура
|    ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки КАК ОстаткиНаСкладах
|        ПО ВсяНоменклатура.Ссылка = ОстаткиНаСкладах.Номенклатура";
```

**Требования к псевдонимам:**
- Образовывать от терминов предметной области
- Удалять пробелы между словами, каждое слово с прописной буквы
- Запрещается начинать с подчеркивания
- Не должны состоять из одного символа

**Источник:** Раздел 10.7 (строки 2733-2753)

---

## Несоответствие индексов и условий запроса

**Правило:** Для всех условий, использованных в запросе, должны существовать подходящие индексы.

**Требования к подходящему индексу:**
1. Индекс содержит все поля, перечисленные в условии
2. Эти поля находятся в самом начале индекса
3. Эти поля идут подряд (без "вклинивания" других полей)

```bsl
// ❌ НЕПРАВИЛЬНО: Отсутствие условия по первому полю индекса
// Регистр: измерения [Склад, Номенклатура, Качество]
Запрос.Текст = 
"ВЫБРАТЬ
|    ТоварыНаСкладахОстатки.Номенклатура
|ИЗ
|    РегистрНакопления.ТоварыНаСкладах.Остатки(, Номенклатура = &Номенклатура) КАК ТоварыНаСкладахОстатки";
// Проблема: отсутствует условие по первому измерению (Склад)

// ✅ ПРАВИЛЬНО: Условие по всем измерениям индекса
Запрос.Текст = 
"ВЫБРАТЬ
|    ТоварыНаСкладахОстатки.Номенклатура
|ИЗ
|    РегистрНакопления.ТоварыНаСкладах.Остатки(, Склад = &Склад И Номенклатура = &Номенклатура) КАК ТоварыНаСкладахОстатки";
```

**Источник:** Раздел 10.9 (строки 2801-2889)

---

## Разыменование ссылочных полей составного типа

**Правило:** При обращении к полям "через точку" от ссылочных полей составного типа следует использовать функцию `ВЫРАЗИТЬ()` для повышения производительности.

```bsl
// ❌ НЕПРАВИЛЬНО: Прямое обращение к реквизитам регистратора
Запрос.Текст = 
"ВЫБРАТЬ
|    Продажи.Регистратор.Номер,
|    Продажи.Регистратор.Дата,
|    Продажи.Контрагент
|ИЗ
|    РегистрНакопления.Продажи КАК Продажи";
// Проблема: SQL-текст будет включать соединения со всеми видами документов

// ✅ ПРАВИЛЬНО: Использование ВЫРАЗИТЬ()
Запрос.Текст = 
"ВЫБРАТЬ
|    ВЫБОР
|        КОГДА Продажи.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
|        ТОГДА ВЫРАЗИТЬ(Продажи.Регистратор КАК Документ.РеализацияТоваровУслуг).Номер
|    КОНЕЦ КАК Номер,
|    Продажи.Контрагент
|ИЗ
|    РегистрНакопления.Продажи КАК Продажи
|ГДЕ
|    Продажи.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг";
```

**Источник:** Раздел 10.10 (строки 2894-3066)

---

## Запросы с вложенными запросами или виртуальными таблицами

**Правило:** Не следует использовать соединения с вложенными запросами. Следует использовать временные таблицы.

```bsl
// ❌ НЕПРАВИЛЬНО: Соединение с вложенным запросом
Запрос.Текст = 
"ВЫБРАТЬ
|    РеализацияТоваровУслуг.Ссылка
|ИЗ
|    Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
|    ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ ИЗ РегистрСведений.Лимиты ГДЕ ... СГРУППИРОВАТЬ ПО ...) КАК Лимиты
|        ПО ...";

// ✅ ПРАВИЛЬНО: Использование временной таблицы
МенеджерВТ = Новый МенеджерВременныхТаблиц;
Запрос = Новый Запрос;
Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
Запрос.Текст = 
"// Заполняем временную таблицу
|ВЫБРАТЬ
|    ...
|ПОМЕСТИТЬ Лимиты
|ИЗ
|    РегистрСведений.Лимиты
|ГДЕ
|    ...
|СГРУППИРОВАТЬ ПО
|    ...
|ИНДЕКСИРОВАТЬ ПО
|    ...;
|
|// Выполняем основной запрос
|ВЫБРАТЬ
|    РеализацияТоваровУслуг.Ссылка
|ИЗ
|    Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
|    ЛЕВОЕ СОЕДИНЕНИЕ Лимиты
|        ПО ...";
```

**Источник:** Раздел 10.11 (строки 3067-3107)

---

## Обращения к виртуальным таблицам

**Правило:** При использовании виртуальных таблиц следует передавать все условия в параметры таблиц, а не в секцию `ГДЕ`.

```bsl
// ❌ НЕПРАВИЛЬНО: Условие в секции ГДЕ
Запрос.Текст = 
"ВЫБРАТЬ
|    Номенклатура
|ИЗ
|    РегистрНакопления.ТоварыНаСкладах.Остатки()
|ГДЕ
|    Склад = &Склад";

// ✅ ПРАВИЛЬНО: Условие в параметрах виртуальной таблицы
Запрос.Текст = 
"ВЫБРАТЬ
|    Номенклатура
|ИЗ
|    РегистрНакопления.ТоварыНаСкладах.Остатки(, Склад = &Склад)";
```

**Источник:** Раздел 10.13 (строки 3128-3189)

---

## Использование логического ИЛИ в условиях запросов

**Правило:** Не следует использовать `ИЛИ` в секции `ГДЕ` запроса. Следует разбить запрос на несколько и объединить результаты.

```bsl
// ❌ НЕПРАВИЛЬНО: Использование ИЛИ в ГДЕ
Запрос.Текст = 
"ВЫБРАТЬ
|    Товар.Наименование
|ИЗ
|    Справочник.Товары КАК Товар
|ГДЕ
|    Артикул = ""001"" ИЛИ Артикул = ""002""";

// ✅ ПРАВИЛЬНО: Разделение на несколько запросов с ОБЪЕДИНИТЬ
Запрос.Текст = 
"ВЫБРАТЬ
|    Товар.Наименование
|ИЗ
|    Справочник.Товары КАК Товар
|ГДЕ
|    Артикул = ""001""
|ОБЪЕДИНИТЬ ВСЕ
|ВЫБРАТЬ
|    Товар.Наименование
|ИЗ
|    Справочник.Товары КАК Товар
|ГДЕ
|    Артикул = ""002""";
```

**Источник:** Раздел 10.14 (строки 3191-3242)

---

## Чек-лист проверки

- [ ] Все ключевые слова запроса написаны заглавными буквами
- [ ] Псевдонимы полей указаны явно с использованием `КАК`
- [ ] Текст запроса структурирован (не в одну строку)
- [ ] Сложные запросы содержат комментарии
- [ ] Избегается многократное выполнение однотипных запросов (N+1)
- [ ] Проверка на пустой результат выполняется через метод `Пустой()`
- [ ] Не используется `ПОЛНОЕ ВНЕШНЕЕ СОЕДИНЕНИЕ` (если возможно)
- [ ] Результаты запроса упорядочены (если требуется)
- [ ] Псевдонимы источников данных осмысленные
- [ ] Условия запроса соответствуют индексам
- [ ] Для составных типов используется `ВЫРАЗИТЬ()`
- [ ] Не используются соединения с вложенными запросами (используются временные таблицы)
- [ ] Условия для виртуальных таблиц передаются в параметры
- [ ] Не используется `ИЛИ` в секции `ГДЕ` (используется `ОБЪЕДИНИТЬ`)

---

**Ссылки на исходный документ:**
- Раздел 10.1: Оформление текстов запросов (строки 2418-2448)
- Раздел 10.2: Многократное выполнение однотипных запросов (строки 2488-2496)
- Раздел 10.3: Проверка на пустой результат (строки 2498-2528)
- Раздел 10.4: Ограничение на ПОЛНОЕ ВНЕШНЕЕ СОЕДИНЕНИЕ (строки 2530-2574)
- Раздел 10.5: Упорядочивание результатов (строки 2591-2615)
- Раздел 10.7: Псевдонимы источников данных (строки 2733-2753)
- Раздел 10.9: Несоответствие индексов и условий (строки 2801-2889)
- Раздел 10.10: Разыменование ссылочных полей (строки 2894-3066)
- Раздел 10.11: Запросы с вложенными запросами (строки 3067-3107)
- Раздел 10.13: Обращения к виртуальным таблицам (строки 3128-3189)
- Раздел 10.14: Использование логического ИЛИ (строки 3191-3242)

