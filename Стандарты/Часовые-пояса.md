# Стандарт работы с часовыми поясами

**Версия:** 1.0  
**Приоритет:** Высокий  
**Источник:** Раздел "Работа в разных часовых поясах" (строки 172-219)

---

## Описание

Конфигурации должны быть рассчитаны на работу в условиях, когда часовой пояс на серверном компьютере не совпадает с реальным часовым поясом пользователей информационной базы. Например, с сервером, расположенным в Москве, работают сотрудники компании из Владивостока, и при этом все операции в системе должны выполняться по местному времени (Владивостока).

Такой сценарий работы часто востребован в клиент-серверных информационных базах и в прикладных решениях в модели сервиса (SaaS).

---

## Правила

### Правило 1: Использование ТекущаяДатаСеанса вместо ТекущаяДата на сервере

**Критично:** Во всех серверных процедурах и функциях вместо функции `ТекущаяДата`, которая возвращает дату и время серверного компьютера, следует использовать функцию `ТекущаяДатаСеанса`, которая приводит время сервера к часовому поясу пользовательского сеанса.

```bsl
// ❌ НЕПРАВИЛЬНО: Использование ТекущаяДата на сервере
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    Если Не ЗначениеЗаполнено(Объект.ПериодРегистрации) Тогда
        Объект.ПериодРегистрации = НачалоМесяца(ТекущаяДата()); // ОШИБКА
    КонецЕсли;
КонецПроцедуры

// ✅ ПРАВИЛЬНО: Использование ТекущаяДатаСеанса на сервере
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    Если Не ЗначениеЗаполнено(Объект.ПериодРегистрации) Тогда
        Объект.ПериодРегистрации = НачалоМесяца(ТекущаяДатаСеанса()); // ПРАВИЛЬНО
    КонецЕсли;
КонецПроцедуры
```

**Источник:** Раздел "Работа в разных часовых поясах", пункт 2.1

---

### Правило 2: Использование УниверсальноеВремя для универсальных отметок времени

**Критично:** В тех случаях, когда требуется «универсальная» отметка времени, не зависящая от часового пояса текущего сеанса пользователя, в контексте которого выполняется серверный вызов, следует использовать функцию `УниверсальноеВремя`. Например, для определения момента перезаполнения закешированных данных, для получения времени последнего выполнения фонового задания и т.п.

```bsl
// ✅ ПРАВИЛЬНО: Использование УниверсальноеВремя для универсальных отметок
ДатаАктуальностиУниверсальная = УниверсальноеВремя(ПолнотекстовыйПоиск.ДатаАктуальности());
ДатаАктуальности = МестноеВремя(ДатаАктуальностиУниверсальная, ЧасовойПоясСеанса());
```

**Источник:** Раздел "Работа в разных часовых поясах", пункт 2.2

---

### Правило 3: Приведение локальной даты серверного компьютера

**Критично:** При использовании методов платформы, возвращающих локальную дату серверного компьютера, следует приводить ее либо к универсальному времени, либо к времени пользовательского сеанса.

**Источник:** Раздел "Работа в разных часовых поясах", пункт 2.3

---

### Правило 4: Запрет использования ТекущаяДата в клиентском коде

**Критично:** В клиентском коде использование функции `ТекущаяДата` также недопустимо. Это требование обусловлено тем, что текущее время, вычисленное в клиентском и серверном коде, не должно различаться.

```bsl
// ❌ НЕПРАВИЛЬНО: Использование ТекущаяДата на клиенте
&НаКлиенте
Процедура КомандаОткрытьЗакрытиеМесяца(Команда)
    ТекущиеДанные = Элементы.Список.ТекущиеДанные;
    Если ТекущиеДанные = Неопределено Тогда
        ТекДата = ТекущаяДата(); // ОШИБКА: вызов ТекущаяДата() на клиенте
    Иначе
        ТекДата = ТекущиеДанные.Дата;
    КонецЕсли;
    ПараметрыФормы = Новый Структура;
    ПараметрыФормы.Вставить("ПериодРегистрации", ТекДата);
    ОткрытьФорму("Обработка.ЗакрытиеМесяца.Форма.Форма", ПараметрыФормы, ЭтотОбъект);
КонецПроцедуры

// ✅ ПРАВИЛЬНО: Перенос получения текущей даты на сервер
&НаКлиенте
Процедура КомандаОткрытьЗакрытиеМесяца(Команда)
    ТекущиеДанные = Элементы.Список.ТекущиеДанные;
    Если ТекущиеДанные = Неопределено Тогда
        ТекДата = Неопределено; // нет вызова ТекущаяДата() на клиенте
    Иначе
        ТекДата = ТекущиеДанные.Дата;
    КонецЕсли;
    ПараметрыФормы = Новый Структура;
    ПараметрыФормы.Вставить("ПериодРегистрации", ТекДата);
    ОткрытьФорму("Обработка.ЗакрытиеМесяца.Форма.Форма", ПараметрыФормы, ЭтотОбъект);
КонецПроцедуры

// И в форме обработки использовать ТекущаяДатаСеанса:
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    ЗаполнитьЗначенияСвойств(Объект, Параметры);
    Если Не ЗначениеЗаполнено(Объект.ПериодРегистрации) Тогда
        Объект.ПериодРегистрации = НачалоМесяца(ТекущаяДатаСеанса());
    КонецЕсли;
КонецПроцедуры
```

**Источник:** Раздел "Работа в разных часовых поясах", пункт 3.1

---

### Правило 5: Использование даты документа вместо текущей даты

**Рекомендация:** При работе с документами следует рассмотреть возможность использования даты самого документа вместо текущей даты.

```bsl
// ❌ НЕПРАВИЛЬНО: Использование ТекущаяДата на клиенте
&НаКлиенте
Процедура ПодборТовары(Команда)
    ПараметрыПодбора = Новый Структура;
    ДатаРасчетов = ?(НачалоДня(Объект.Дата) = НачалоДня(ТекущаяДата()), Неопределено, Объект.Дата);
    // ОШИБКА: вызов ТекущаяДата() на клиенте
    ПараметрыПодбора.Вставить("ДатаРасчетов", ДатаРасчетов);
    ОткрытьФорму("Обработка.ПодборНоменклатуры.Форма.Форма", ПараметрыПодбора, ЭтотОбъект, УникальныйИдентификатор);
КонецПроцедуры

// ✅ ПРАВИЛЬНО: Передача даты документа, вычисление на сервере
&НаКлиенте
Процедура ПодборТовары(Команда)
    ПараметрыПодбора = Новый Структура;
    ПараметрыПодбора.Вставить("ДатаРасчетов", Объект.Дата);
    ОткрытьФорму("Обработка.ПодборНоменклатуры.Форма.Форма", ПараметрыПодбора, ЭтотОбъект, УникальныйИдентификатор);
КонецПроцедуры
```

**Источник:** Раздел "Работа в разных часовых поясах", пункт 3.3

---

### Правило 6: Избегание многократных обращений к ТекущаяДатаСеанса

**Рекомендация:** Следует избегать в коде одной процедуры (функции) многократного обращения к функции `ТекущаяДатаСеанса` (или `ТекущаяДата`), так как возвращаемые значения будут отличаться друг от друга.

```bsl
// ❌ НЕПРАВИЛЬНО: Многократные обращения к ТекущаяДатаСеанса
ДатаПоследнегоОповещения = ТекущаяДатаСеанса();
ДатаСледующегоОповещения = РассчитатьДату() + ТекущаяДатаСеанса(); // ОШИБКА: разные значения

// ✅ ПРАВИЛЬНО: Использование ранее рассчитанной даты
ДатаПоследнегоОповещения = ТекущаяДатаСеанса();
ДатаСледующегоОповещения = РассчитатьДату() + ДатаПоследнегоОповещения;
```

**Источник:** Раздел "Работа в разных часовых поясах", пункт 5

---

## Исключения

Исключения из правил 2 и 3 возможны в отдельных, обоснованных случаях, когда требуется использовать действительно текущее время серверного компьютера. Такие исключения должны быть обоснованы в тексте комментария к вызову.

**Источник:** Раздел "Работа в разных часовых поясах", пункт 4

---

## Чек-лист проверки

- [ ] Все серверные процедуры используют `ТекущаяДатаСеанса` вместо `ТекущаяДата`
- [ ] Для универсальных отметок времени используется `УниверсальноеВремя`
- [ ] В клиентском коде нет вызовов `ТекущаяДата`
- [ ] При работе с документами используется дата документа вместо текущей даты
- [ ] Избегаются многократные обращения к `ТекущаяДатаСеанса` в одной процедуре
- [ ] Исключения из правил обоснованы комментариями

---

**Ссылка на исходный документ:** Раздел "Работа в разных часовых поясах" (строки 172-219)

